import telebot
from telebot import types

# 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
API_TOKEN = '8468897119:AAGJOiVe9JmgT34LGxogkqs3xFEewJUSzmU'

bot = telebot.TeleBot(API_TOKEN)

# user_states: –ö—Ç–æ –∫–æ–º—É –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã {id_–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: id_–ø–æ–ª—É—á–∞—Ç–µ–ª—è}
user_states = {}

# reply_map: –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª –°–í–ê–ô–ü
# –§–æ—Ä–º–∞—Ç: { "ID—á–∞—Ç–∞_ID—Å–æ–æ–±—â–µ–Ω–∏—è": ID_—Ä–µ–∞–ª—å–Ω–æ–≥–æ_–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è }
reply_map = {}

# 2. –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î–´ /START
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.chat.id
    text_parts = message.text.split()

    # –°–¶–ï–ù–ê–†–ò–ô –ê: –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ (—Ö–æ—á–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å)
    if len(text_parts) > 1:
        recipient_id = text_parts[1]

        if str(recipient_id) == str(user_id):
            bot.send_message(user_id, "‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ.")
            return

        user_states[user_id] = int(recipient_id)

        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add(types.KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞"))

        bot.send_message(
            user_id,
            "üöÄ –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ:",
            parse_mode="Markdown",
            reply_markup=markup
        )

    # –°–¶–ï–ù–ê–†–ò–ô –ë: –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞ (—Ö–æ—á–µ—Ç —Å–≤–æ—é —Å—Å—ã–ª–∫—É)
    else:
        if user_id in user_states: del user_states[user_id]
        
        bot_username = bot.get_me().username
        link = f"https://t.me/{bot_username}?start={user_id}"
        
        markup = types.InlineKeyboardMarkup(row_width=1)
        btn_share = types.InlineKeyboardButton("üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π", url=f"https://t.me/share/url?url={link}&text=–ó–∞–¥–∞–π –º–Ω–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å!")
        btn_add = types.InlineKeyboardButton("üë• –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ —á–∞—Ç", url=f"https://t.me/{bot_username}?startgroup=true")
        markup.add(btn_share, btn_add)

        bot.send_message(
            user_id,
            f"–ù–∞—á–Ω–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!\n\nüëâ {link}\n\n–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.",
            parse_mode="Markdown",
            reply_markup=markup
        )

# 3. –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô (–¢–ï–ö–°–¢ –ò –§–û–¢–û)
@bot.message_handler(content_types=['text', 'photo'])
def handle_message(message):
    user_id = message.chat.id
    
    # --- –ü–†–û–í–ï–†–ö–ê –ù–ê –û–¢–ú–ï–ù–£ ---
    if message.content_type == 'text' and message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        if user_id in user_states: del user_states[user_id]
        bot.send_message(user_id, "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=types.ReplyKeyboardRemove())
        send_welcome(message)
        return

    # --- –õ–û–ì–ò–ö–ê 1: –≠–¢–û –û–¢–í–ï–¢ (–°–í–ê–ô–ü) ---
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å–≤–∞–π–ø–Ω—É–ª –µ–≥–æ)
    if message.reply_to_message:
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—Ç–∏–ª–∏
        reply_key = f"{user_id}_{message.reply_to_message.message_id}"
        
        if reply_key in reply_map:
            original_sender_id = reply_map[reply_key]
            
            try:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                answer_text = message.text if message.content_type == 'text' else message.caption or "–§–æ—Ç–æ"
                
                if message.content_type == 'photo':
                    bot.send_photo(original_sender_id, message.photo[-1].file_id, caption=f"üí¨ <b>–í–∞–º –ø—Ä–∏—à–µ–ª –æ—Ç–≤–µ—Ç:</b>\n\n{answer_text}", parse_mode="HTML")
                else:
                    bot.send_message(original_sender_id, f"üí¨ <b>–í–∞–º –ø—Ä–∏—à–µ–ª –æ—Ç–≤–µ—Ç:</b>\n\n{message.text}", parse_mode="HTML")
                
                bot.send_message(user_id, "‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–Ω–æ–Ω–∏–º—É!")
            except Exception:
                bot.send_message(user_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞).")
        else:
            bot.send_message(user_id, "‚ö†Ô∏è –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ, —è –Ω–µ –ø–æ–º–Ω—é –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.")
        return

# --- –õ–û–ì–ò–ö–ê 2: –û–¢–ü–†–ê–í–ö–ê –ù–û–í–û–ì–û –í–û–ü–†–û–°–ê ---
    if user_id in user_states:
        recipient_id = user_states[user_id]
        
        try:
            # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            msg_text = message.text if message.content_type == 'text' else message.caption or ""
            # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç (–ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏), —Å—Ç–∞–≤–∏–º –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
            if not msg_text and message.content_type == 'photo': msg_text = " "

            # –§–û–†–ú–ò–†–£–ï–ú –í–ò–î –ö–ê–ö –ù–ê –°–ö–†–ò–ù–®–û–¢–ï (HTML)
            # <blockquote> –¥–µ–ª–∞–µ—Ç —Ç—É —Å–∞–º—É—é –ø–æ–ª–æ—Å–∫—É
            formatted_text = (
                "üíò <b>–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</b>\n\n"
                f"<blockquote>{msg_text}</blockquote>\n"
                "‚Ü©Ô∏è –°–≤–∞–π–ø–Ω–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞."
            )

            sent_msg = None
            if message.content_type == 'photo':
                sent_msg = bot.send_photo(recipient_id, message.photo[-1].file_id, caption=formatted_text, parse_mode="HTML")
            else:
                sent_msg = bot.send_message(recipient_id, formatted_text, parse_mode="HTML")
            
            # –ó–ê–ü–û–ú–ò–ù–ê–ï–ú ID –°–û–û–ë–©–ï–ù–ò–Ø –î–õ–Ø –°–í–ê–ô–ü–ê
            # –ö–ª—é—á = ID–ø–æ–ª—É—á–∞—Ç–µ–ª—è_ID—Å–æ–æ–±—â–µ–Ω–∏—è
            reply_map[f"{recipient_id}_{sent_msg.message_id}"] = user_id

            # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
            delete_data = f"delete_{recipient_id}_{sent_msg.message_id}"
            markup_sender = types.InlineKeyboardMarkup()
            markup_sender.add(
                types.InlineKeyboardButton("–ù–∞–ø–∏—Å–∞—Ç—å –µ—â—ë ‚úçÔ∏è", callback_data='write_more'),
                types.InlineKeyboardButton("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ üóë", callback_data=delete_data)
            )

            bot.send_message(user_id, "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", reply_markup=markup_sender)
        
        except Exception as e:
            bot.send_message(user_id, "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω).")
            print(e)
            
    else:
        bot.send_message(user_id, "–ù–∞–∂–º–∏—Ç–µ /start, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É.")

# 4. –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö –£–î–ê–õ–ï–ù–ò–Ø (–£ –û–¢–ü–†–ê–í–ò–¢–ï–õ–Ø)
@bot.callback_query_handler(func=lambda call: True)
def callback_inline(call):
    try:
        if call.data.startswith('delete_'):
            parts = call.data.split('_')
            recipient_id, msg_id = parts[1], parts[2]
            
            # –£–¥–∞–ª—è–µ–º —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            try: bot.delete_message(recipient_id, msg_id)
            except: pass
            # –£–¥–∞–ª—è–µ–º —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            try: bot.delete_message(call.message.chat.id, call.message.message_id)
            except: pass
            
            bot.answer_callback_query(call.id, "–£–¥–∞–ª–µ–Ω–æ!")

        elif call.data == 'write_more':
            bot.answer_callback_query(call.id, "–ü–∏—à–∏—Ç–µ...")
            try: bot.delete_message(call.message.chat.id, call.message.message_id)
            except: pass

    except Exception as e:
        print(f"Error: {e}")

print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.infinity_polling(skip_pending=True)
